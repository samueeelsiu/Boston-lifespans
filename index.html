<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Building Demolition Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@4.2.7/build/index.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .error-message {
            background: #fee;
            border-left: 4px solid #c00;
            padding: 15px;
            margin: 20px 0;
            color: #800;
        }

        .data-note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        .methodology {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin-top: 20px;
        }

        .methodology h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .methodology p {
            color: #555;
            margin-bottom: 10px;
        }

        .stats-value {
            font-weight: bold;
            color: #3498db;
        }

        .controls {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .control-group label {
            display: inline-block;
            margin-right: 8px;
            font-weight: 500;
        }

        select, input[type="radio"] {
            margin-right: 5px;
        }

        select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .radio-group {
            display: inline-block;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .radio-group input[type="radio"] {
            margin-right: 5px;
        }

        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-container {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container.hidden {
            display: none;
        }

        /* Heatmap styles */
        .heatmap-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 2px;
            font-size: 0.9em;
        }

        .heatmap-table th {
            background: #2c3e50;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .heatmap-table th.material-header {
            text-align: left;
            padding-left: 15px;
            min-width: 120px;
        }

        .heatmap-table td {
            padding: 8px;
            text-align: center;
            position: relative;
            min-width: 80px;
            transition: all 0.2s ease;
        }

        .heatmap-table td.material-name {
            font-weight: 500;
            background: #f8f9fa;
            text-align: left;
            padding-left: 15px;
            color: #2c3e50;
            border-right: 2px solid #dee2e6;
        }

        .heatmap-cell {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: 500;
        }

        .heatmap-table tr:hover td:not(.material-name) {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-gradient {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gradient-bar {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, rgb(240, 249, 33), rgb(253, 206, 2), rgb(254, 153, 61), rgb(251, 127, 88), rgb(235, 101, 105), rgb(216, 77, 120), rgb(196, 54, 136), rgb(172, 33, 152), rgb(144, 13, 163), rgb(114, 1, 168), rgb(82, 2, 165), rgb(47, 7, 164), rgb(13, 8, 135));
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .view-toggle button:hover:not(.active) {
            background: #f8f9fa;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .chart-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        canvas {
            max-height: 400px;
        }

        .material-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .material-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        .material-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .city-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }

        .city-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .city-count {
            color: #666;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        #mapContainer {
            height: 500px;
            width: 100%;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .map-legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .map-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }


        .mini-stat { display: inline-block; margin-right: 10px; margin-bottom: 10px; vertical-align: top; }
        .badge { display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; line-height:1.6; border:1px solid; margin-right:6px; white-space:nowrap; }
        .badge-close { background:#e6ffed; border-color:#22c55e; color:#166534; }
        .badge-open  { background:#fff7ed; border-color:#f97316; color:#9a3412; }
        .status-row { margin-top:6px; }
        
        #zoningOverviewTable th { background: #f8f9fa; position: sticky; top: 0; z-index: 1; }
        #zoningOverviewTable tr:hover { background: #f1f8ff; cursor: pointer; }
        .badge-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Boston Building Demolition Analysis</h1>
            <p class="subtitle" id="subtitle">Data From NSI enhanced USA Structure(MA) dataset</p>
            
            <div class="methodology" style="background: #f8f9fa; padding: 25px; border-left: 5px solid #3498db; border-radius: 4px; margin-top: 20px;">
                <h3 style="color: #2c3e50; margin-top: 0;">Data Source & Methodology</h3>
                <p style="color: #555; margin-bottom: 15px;">
                    This dashboard analyzes building demolition patterns in the Greater Boston area, combining NSI structural data with Boston zoning regulations.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #3498db;">Data Processing & Cleaning</h4>
                        <ol style="margin-left: 20px; padding-left: 0; line-height: 1.5; color: #444; font-size: 0.9em;">
                            <li style="margin-bottom: 6px;">
                                <strong>Permit Matching Strategy:</strong> 
                                Building Polygons were linked to Demolition Permits using a <strong>Nearest Neighbor Spatial Join</strong> with a <strong>5-meter search radius</strong> (EPSG:2249).
                                
                                <div style="background: #eef2f7; padding: 8px 12px; border-radius: 4px; margin: 8px 0; font-size: 0.9em; border-left: 3px solid #3498db; color: #555;">
                                    <strong>Matching Stats (Total: 5,018):</strong><br>
                                    <span style="color: #27ae60;">●</span> <strong>Exact Matches:</strong> 4,922 (98.1%)<br>
                                    <span style="color: #e67e22;">●</span> <strong>Buffer Matches (<5m):</strong> 96 (1.9%)
                                </div>
                                <span style="color:#666; font-size:0.9em;">This logic ensures permits with slight geocoding offsets are correctly attributed to the nearest structure.</span>
                            </li>
                            
                            <li style="margin-bottom: 6px;">
                                <strong>Conflict Resolution:</strong> 
                                Where multiple permits matched a single building, priority was given to <strong>Closed</strong> status and the <strong>Most Recent</strong> date.
                            </li>

                            <li style="margin-bottom: 6px;">
                                <strong>Geometry Conversion:</strong> 
                                Post-matching, building footprints (Polygons) were converted to <strong>Centroids (Points)</strong> for visualization.
                            </li>
                            
                            <li style="margin-bottom: 6px;">
                                <strong>Geographic Filtering:</strong> Data was filtered to include only major Greater Boston municipalities (Boston, Cambridge, Somerville, etc.).
                            </li>
                            
                            <li style="margin-bottom: 6px;">
                                <strong>Spatial Integration:</strong> Demolition points were spatially joined with <code>Boston_Zoning_Subdistricts.geojson</code>.
                            </li>
                            
                            <li style="margin-bottom: 6px;">
                                <strong>Outlier Removal:</strong> Records with calculated lifespans <strong>≥ 500 years</strong> were removed.
                            </li>
                        </ol>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 10px; color: #3498db;">Calculation Logic</h4>
                        <ul style="list-style-type: none; padding: 0; font-size: 0.9em; line-height: 1.6;">
                            <li style="margin-bottom: 8px;">
                                <strong>Lifespan Calculation & Filtering:</strong> <code>Demolition Year - Year Built</code>.
                                <br><span style="color:#666; font-size:0.9em;">• <strong>Positive Lifespan (>0 yrs):</strong> Represents a complete, valid building lifecycle. Used in <strong>ALL</strong> visualizations (Maps, Heatmaps, Age Distributions, Boxplots, etc.) to ensure statistical accuracy.</span>
                                <br><span style="color:#666; font-size:0.9em;">• <strong>Non-Positive Lifespan (≤0 yrs):</strong> Indicates rapid redevelopment (e.g., "Demolished & Replaced" in the same year) or data anomalies. These are <strong>strictly excluded</strong> from all charts except for:
                                    <ul style="margin-top:4px; margin-left:15px;">
                                        <li>The <em>"Demolitions by Year"</em> stacked chart (shown as a distinct dark grey category).</li>
                                        <li>The <em>"RAZE Lifespan Summary"</em> statistics badges.</li>
                                    </ul>
                                </span>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <strong>Current Buildings Definition:</strong> 
                                Calculated as the total dataset <em>minus</em> buildings confirmed as demolished.
                                <br><span style="color:#666; font-size:0.9em;">• Buildings with a <strong>RAZE</strong> permit and <strong>Positive Lifespan</strong> are <span style="color:#e74c3c; font-weight:500;">removed</span> from the "Current Age" charts, as they no longer exist.</span>
                                <br><span style="color:#666; font-size:0.9em;">• Buildings with a <strong>RAZE</strong> permit but <strong>Lifespan ≤ 0</strong> are <span style="color:#27ae60; font-weight:500;">retained</span>. These "Demolished & Replaced" records represent the active structure currently on the parcel.</span>
                            </li>
                            <li style="margin-bottom: 8px;">
                                <strong>Status Inference:</strong> Derived from <code>DEMOLITION_STATUS</code> using exclusion logic. Any record <em>not</em> explicitly 'Closed' (e.g., 'Open', 'Issued', 'Pending', or Null) is classified as <strong>Open</strong>.
                            </li>
                        </ul>
                        
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 0.9em; color: #666;">
                            <strong>Dataset Scope:</strong><br>
                            Source: <span class="stats-value" id="totalMABuildings" style="font-weight:600; color:#2c3e50;">-</span> MA buildings<br>
                            Target: <span class="stats-value" id="bostonDemolitions" style="font-weight:600; color:#2c3e50;">-</span> Boston area records<br>
                            Targeted Built Year Range: <span class="stats-value" id="yearBuiltRange" style="font-weight:600; color:#2c3e50;">-</span><br>
                            Permit Range: <span class="stats-value" id="dateRange" style="font-weight:600; color:#2c3e50;">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading data...</div>

        <div id="mainContent" style="display: none;">
            <div class="controls">
                <div class="control-group">
                    <label><strong>Demolition Type:</strong></label>
                    <div class="radio-group">
                        <label><input type="radio" name="demolitionView" value="all" onchange="updateDemolitionView()"> All Types</label>
                        <label><input type="radio" name="demolitionView" value="RAZE" checked onchange="updateDemolitionView()"> RAZE Only</label>
                        <label><input type="radio" name="demolitionView" value="EXTDEM" onchange="updateDemolitionView()"> EXTDEM Only</label>
                        <label><input type="radio" name="demolitionView" value="INTDEM" onchange="updateDemolitionView()"> INTDEM Only</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Lifespan Bin Size:</label>
                    <select id="lifespanBinSize" onchange="updateVisualization()">
                        <option value="10">10 Years</option>
                        <option value="20" selected>20 Years</option>
                        <option value="25">25 Years</option>
                        <option value="30">30 Years</option>
                        <option value="50">50 Years</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Display:</label>
                    <select id="viewMode" onchange="updateVisualization()">
                        <option value="count">Count</option>
                        <option value="percentage">Percentage</option>
                    </select>
                </div>

            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Demolitions</div>
                    <div class="stat-number" id="totalDemo">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" id="avgLifespanLabel">Average Lifespan</div>
                    <div class="stat-number" id="avgLifespan">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">EXTDEM</div>
                    <div class="stat-number" id="extdemCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">INTDEM</div>
                    <div class="stat-number" id="intdemCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">RAZE</div>
                    <div class="stat-number" id="razeCount">-</div>
                </div>
            </div>

            <div class="chart-container" id="raze-lifespan-summary-container">
                <h2 class="chart-title">RAZE Lifespan Summary</h2>
                
                <div class="badge-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    
                    <div class="mini-stat" style="padding:15px; border:1px solid #eee; border-radius:8px; width: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="font-size:12px; opacity:.75; margin-bottom: 5px;">RAZE lifespan > 0</div>
                        <div id="razePosCount" style="font-weight:700; font-size:1.4em; color: #2c3e50; margin-bottom: 8px;">-</div>
                        <div class="status-row" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <span id="razePosClose" class="badge badge-close" style="flex:1; text-align:center; margin:0;">- Close</span>
                            <span id="razePosOpen"  class="badge badge-open" style="flex:1; text-align:center; margin:0;">- Open</span>
                        </div>
                    </div>

                    <div class="mini-stat" style="padding:15px; border:1px solid #eee; border-radius:8px; width: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="font-size:12px; opacity:.75; margin-bottom: 5px;">RAZE lifespan = 0</div>
                        <div id="razeZeroCount" style="font-weight:700; font-size:1.4em; color: #2c3e50; margin-bottom: 8px;">-</div>
                        <div class="status-row" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <span id="razeZeroClose" class="badge badge-close" style="flex:1; text-align:center; margin:0;">- Close</span>
                            <span id="razeZeroOpen"  class="badge badge-open" style="flex:1; text-align:center; margin:0;">- Open</span>
                        </div>
                    </div>

                    <div class="mini-stat" style="padding:15px; border:1px solid #eee; border-radius:8px; width: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="font-size:12px; opacity:.75; margin-bottom: 5px;">RAZE lifespan < 0</div>
                        <div id="razeNegCount" style="font-weight:700; font-size:1.4em; color: #2c3e50; margin-bottom: 8px;">-</div>
                        <div class="status-row" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <span id="razeNegClose" class="badge badge-close" style="flex:1; text-align:center; margin:0;">- Close</span>
                            <span id="razeNegOpen"  class="badge badge-open" style="flex:1; text-align:center; margin:0;">- Open</span>
                        </div>
                    </div>

                    <div class="mini-stat" style="padding:15px; border:1px solid #eee; border-radius:8px; width: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05); background-color: #f8f9fa;">
                        <div style="font-size:12px; opacity:.75; margin-bottom: 5px; font-weight: 600;">RAZE Total (All)</div>
                        <div id="razeTotalCount" style="font-weight:800; font-size:1.4em; color: #130887; margin-bottom: 8px;">-</div>
                        <div class="status-row" style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <span id="razeTotalClose" class="badge badge-close" style="flex:1; text-align:center; margin:0;">- Close</span>
                            <span id="razeTotalOpen"  class="badge badge-open" style="flex:1; text-align:center; margin:0;">- Open</span>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="view-toggle">
                <h3 style="margin-right: 10px; color: #2c3e50; align-self: center;">Material View:</h3>
                <button id="heatmapBtn" class="active" onclick="setVisualizationType('heatmap')">Heatmap</button>
                <button id="stackedBtn" onclick="setVisualizationType('stacked')">Stacked Bar</button>
                
                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px; background: white; padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                <span style="font-weight: 500; font-size: 0.9em;">Metric:</span>
                    <label style="font-size: 0.9em; cursor: pointer;">
                        <input type="radio" name="globalMetric" value="count" checked onchange="updateVisualization()"> Count
                    </label>
                    <label style="font-size: 0.9em; cursor: pointer;">
                        <input type="radio" name="globalMetric" value="count_pct" onchange="updateVisualization()"> Count (%)
                    </label>
                    <label style="font-size: 0.9em; cursor: pointer;">
                        <input type="radio" name="globalMetric" value="gfa" onchange="updateVisualization()"> GFA
                    </label>
                    <label style="font-size: 0.9em; cursor: pointer;">
                        <input type="radio" name="globalMetric" value="gfa_pct" onchange="updateVisualization()"> GFA (%)
                    </label>
                </div>
            </div>

            <div id="heatmapContainer" class="chart-container">
                <h2 class="chart-title">Material vs Lifespan Heatmap</h2>
                <p class="chart-description">Heatmap showing demolition counts for each material-lifespan combination</p>
                <div id="heatmapContent"></div>
            </div>

            <div id="foundationHeatmapContainer" class="chart-container">
                <h2 class="chart-title">Foundation vs Lifespan Heatmap</h2>
                <p class="chart-description">Heatmap showing demolition counts for each foundation-lifespan combination</p>
                <div id="foundationHeatmapContent"></div>
            </div>

                        <div id="allChartContainer" class="chart-container hidden">
                <h2 class="chart-title">All Types: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (All demolition types combined)</p>
                <canvas id="allChart"></canvas>
            </div>

            <div id="razeChartContainer" class="chart-container hidden">
                <h2 class="chart-title">RAZE: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Complete demolition)</p>
                <canvas id="razeChart"></canvas>
            </div>

            <div id="extdemChartContainer" class="chart-container hidden">
                <h2 class="chart-title">EXTDEM: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Exterior demolition)</p>
                <canvas id="extdemChart"></canvas>
            </div>

            <div id="intdemChartContainer" class="chart-container hidden">
                <h2 class="chart-title">INTDEM: Material Type vs Lifespan Distribution</h2>
                <p class="chart-description">Stacked bar chart showing lifespan distribution for each material type (Interior demolition)</p>
                <canvas id="intdemChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Demolition Locations Map (with Zoning Overlay)</h2>
                <p class="chart-description">Map showing the location of demolished buildings</p>
                <div id="mapContainer"></div>
            </div>

            <div class="chart-container" id="zoning-deep-dive">
                <h2 class="chart-title">Zoning District Deep Dive(RAZE only)</h2>
                <p class="chart-description">Select a district to view detailed statistics, age distributions, and material analysis.</p>
                
                <div class="control-group" style="margin-bottom: 15px;">
                    <label>Select District:</label>
                    <select id="zoningDistrictFilter" onchange="updateZoningDeepDive()">
                        <option value="">Select a district...</option>
                    </select>
                </div>

                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 25px; border: 1px solid #eee;">
                    <table id="zoningOverviewTable" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th style="padding:10px;">District</th>
                                <th style="padding:10px; text-align:right;">RAZE Count</th>
                                <th style="padding:10px; text-align:right;">Avg Lifespan</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div style="display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; margin-bottom: 25px; height: 320px;">
                    
                    <div id="zoningMap" style="height: 100%; width: 100%; border-radius: 4px; border: 1px solid #ddd;"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; height: 100%;">
                        
                        <div class="stat-card" style="display: flex; flex-direction: column; justify-content: center; padding: 10px; box-shadow: none; border: 1px solid #eee;">
                            <div class="stat-label" style="font-size:0.8em; margin-bottom: 5px;">Avg Demolished Lifespan</div>
                            <div class="stat-number" id="zoneAvgLifespan" style="font-size: 1.4em; color: #2c3e50;">-</div>
                        </div>

                        <div class="stat-card" style="display: flex; flex-direction: column; justify-content: center; padding: 10px; box-shadow: none; border: 1px solid #eee;">
                            <div class="stat-label" style="font-size:0.8em; margin-bottom: 5px;">RAZE Count</div>
                            <div class="stat-number" id="zoneRazeCount" style="font-size: 1.4em; color: #130887;">-</div>
                        </div>

                        <div class="stat-card" style="display: flex; flex-direction: column; justify-content: center; padding: 10px; box-shadow: none; border: 1px solid #eee;">
                            <div class="stat-label" style="font-size:0.8em; margin-bottom: 5px;">Avg Current Building Age</div>
                            <div class="stat-number" id="zoneAvgAge" style="font-size: 1.4em; color: #2c3e50;">-</div>
                        </div>

                        <div class="stat-card" style="display: flex; flex-direction: column; justify-content: center; padding: 10px; box-shadow: none; border: 1px solid #eee;">
                            <div class="stat-label" style="font-size:0.8em; margin-bottom: 5px;">Total Buildings</div>
                            <div class="stat-number" id="zoneTotalCount" style="font-size: 1.4em; color: #2c3e50;">-</div>
                        </div>

                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 4px; border: 1px solid #eee;">
                        <h4 style="font-size: 0.95em; color: #555; margin-bottom: 10px; text-align: center;">Demolished Building Lifespan Distribution</h4>
                        <div style="height: 220px;">
                            <canvas id="zoningDemolishedAgeChart"></canvas>
                        </div>
                    </div>

                    <div style="background: #f9f9f9; padding: 15px; border-radius: 4px; border: 1px solid #eee;">
                        <h4 style="font-size: 0.95em; color: #555; margin-bottom: 10px; text-align: center;">Current Building Age Distribution</h4>
                        <div style="height: 220px;">
                            <canvas id="zoningCurrentAgeChart"></canvas>
                        </div>
                    </div>

                </div>

                <div style="padding-top: 20px; border-top: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="chart-title" style="font-size: 1.1em; margin: 0;">District Material vs. Lifespan Heatmap (RAZE Only)</h3>
                        
                        <div style="display: flex; gap: 10px; font-size: 0.9em;">
                            <label style="cursor: pointer;"><input type="radio" name="deepDiveMetric" value="count" checked onchange="updateZoningDeepDive()"> Count</label>
                            <label style="cursor: pointer;"><input type="radio" name="deepDiveMetric" value="count_pct" onchange="updateZoningDeepDive()"> Count (%)</label>
                            <label style="cursor: pointer;"><input type="radio" name="deepDiveMetric" value="gfa" onchange="updateZoningDeepDive()"> GFA</label>
                            <label style="cursor: pointer;"><input type="radio" name="deepDiveMetric" value="gfa_pct" onchange="updateZoningDeepDive()"> GFA (%)</label>
                        </div>
                    </div>
                    
                    <div id="zoningHeatmapContainer" style="overflow-x: auto; min-height: 150px;"></div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3 class="chart-title" style="font-size: 1.1em;">District Foundation vs. Lifespan Heatmap (RAZE Only)</h3>
                    <div id="zoningFoundationHeatmapContainer" style="overflow-x: auto;"></div>
                </div>
                
                </div>


            </div>

            


            <div class="chart-container">
                <h2 class="chart-title">Demolitions by Year</h2>
                <canvas id="yearlyChart"></canvas>
            </div>

            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="chart-title" style="margin-bottom: 0;">Age Distribution of Demolished Buildings in Boston</h2>
                    
                    <label style="cursor: pointer; font-size: 0.9em; color: #d35400; background: #fff5e6; padding: 5px 10px; border-radius: 4px; border: 1px solid #ffcc80;">
                        <input type="checkbox" id="logScale" onchange="updateVisualization()"> 
                        Log Scale (View Outliers) 
                        <span style="color: #666; font-size: 0.85em; margin-left: 5px;">(Only affects this & Current Age chart)</span>
                    </label>
                </div>
                
                <canvas id="lifespanChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Age Distribution of Current Buildings in Boston</h2>
                <p class="chart-description">Shows the age distribution of all existing buildings in the Boston property assessment database (Synced X-Axis)</p>
                <canvas id="currentAgeChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Age Distribution of Demolished(Razed) Buildings by Year</h2>
                <p class="chart-description">Shows the relative ages of buildings demolished each year, based on their lifespan at demolition</p>
                <canvas id="ageDistributionChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Construction Era of Demolished Buildings by Year</h2>
                <p class="chart-description">Shows when demolished buildings were originally constructed, grouped by historical eras</p>
                <canvas id="constructionEraChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Building Lifespan Distribution by Demolition(Razed) Year</h2>
                <p class="chart-description">Each point represents a building's age at demolition. Points are jittered horizontally to show density.</p>
                <canvas id="lifespanStripPlot"></canvas>
            </div>



            <div class="chart-container">
                <h2 class="chart-title">Material Type Statistics</h2>
                <table class="material-table" id="materialTable">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Count</th>
                            <th>Avg Lifespan</th>
                            <th>INTDEM</th>
                            <th>EXTDEM</th>
                            <th>RAZE</th>
                        </tr>
                    </thead>
                    <tbody id="materialTableBody"></tbody>
                </table>
            </div>

            <div class="chart-container">
                <h2 class="chart-title" id="boxplotTitle">Building Lifespan by Material Type</h2>
                <p class="chart-description" id="boxplotDescription">Box plot showing the distribution of building lifespans for each material type</p>
                <canvas id="boxplotChart" style="max-height: 500px;"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">Demolitions by City</h2>
                <div class="city-grid" id="cityGrid"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        Data Source: NSI Enhanced USA Structure dataset
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let currentVisualization = 'heatmap'; // Default to heatmap
        let map = null;
        let mapMarkers = [];
        let mapData = null;
        let zoningLayer = null;
        let globalZoningGeoJSON = null;
        let zoningDeepDiveMap = null;
        let zoningDistrictLayer = null;
        let zoningRazePointLayer = null;


        const colors = {
            RAZE: 'rgba(13, 8, 135, 0.8)',  
            EXTDEM: 'rgba(204, 71, 120, 0.8)', 
            INTDEM: 'rgba(254, 206, 50, 0.8)', 
            single: 'rgba(126, 3, 168, 0.8)' ,
            demolished_and_replaced: 'rgba(0, 0, 0, 0.7)'
        };

        const borderColors = {
            RAZE: 'rgba(13, 8, 135, 1)',
            EXTDEM: 'rgba(204, 71, 120, 1)',
            INTDEM: 'rgba(254, 206, 50, 1)',
            single: 'rgba(126, 3, 168, 1)'
        };
        // Color scheme for stacked bar charts (Darkest for largest, lightest for smallest)
        function getLifespanColors(count) {
            // Plasma colormap reversed for "darkest for largest"
            const plasmaColorsReversed = [
                [240, 249, 33],    // Bright yellow (min)
                [248, 230, 33],
                [253, 206, 2],
                [254, 180, 31],
                [254, 153, 61],
                [251, 127, 88],
                [235, 101, 105],
                [216, 77, 120],
                [196, 54, 136],
                [172, 33, 152],
                [144, 13, 163],
                [114, 1, 168],
                [82, 2, 165],
                [47, 7, 164],
                [13, 8, 135]      // Dark purple (max)
            ];
            
            const colors = [];
            for (let i = 0; i < count; i++) {
                const idx = Math.floor((i / count) * plasmaColorsReversed.length);
                const rgb = plasmaColorsReversed[Math.min(idx, plasmaColorsReversed.length - 1)];
                colors.push(`rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.85)`);
            }
            return colors.reverse(); 
        }

        // Modified Plasma colormap for heatmap with LINEAR scale (Light yellow for min, Dark purple for max)
        function getPlasmaColor(value, maxValue) {
            if (value === 0) return '#f0f0f0'; // Light gray for zero
            
            // Use LINEAR scale instead of log scale
            const intensity = maxValue > 0 ? value / maxValue : 0;
            
            const plasmaColors = [
                [240, 249, 33], [248, 230, 33], [253, 206, 2], [254, 180, 31],
                [254, 153, 61], [251, 127, 88], [235, 101, 105], [216, 77, 120],
                [196, 54, 136], [172, 33, 152], [144, 13, 163], [114, 1, 168],
                [82, 2, 165], [47, 7, 164], [13, 8, 135]
            ];
            
            const idx = Math.min(Math.floor(intensity * (plasmaColors.length -1)), plasmaColors.length - 1);
            const rgb = plasmaColors[idx];
            return `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        }

        // --- Helpers for Axis Synchronization ---
        function parseRange(str) {
            const m = String(str).match(/(\d+)\s*-\s*(\d+)/); 
            return m ? [parseInt(m[1]), parseInt(m[2])] : [0, 0]; 
        }

        function getUpperFromSeries(series = []) {
            let max = 0;
            series.forEach(d => {
                const [, end] = parseRange(d.range); 
                if (end > max) max = end;
            });
            return max;
        }

        function computeGlobalMaxAge(data) {
            const maxCurrent = getUpperFromSeries(data.current_age_distribution_10yr || []); 
            const maxDem = getUpperFromSeries(data.lifespan_distribution || []); 
            return Math.max(maxCurrent, maxDem, 150); // Default min 150
        }
        
        function initializeMap() {
            if (map) return; 
            
            map = L.map('mapContainer').setView([42.3601, -71.0589], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            if (globalZoningGeoJSON) {
                zoningLayer = L.geoJSON(globalZoningGeoJSON, {
                    style: function(feature) {
                        return { color: "#800080", weight: 1, opacity: 0.6, fillColor: "#800080", fillOpacity: 0.1 };
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties && feature.properties.Zoning_Subdistrict) {
                            const name = feature.properties.Zoning_Subdistrict;
                            let txt = `<strong>${name}</strong>`;
                            if (currentData && currentData.zoning_subdistrict_stats && currentData.zoning_subdistrict_stats[name]) {
                                const stats = currentData.zoning_subdistrict_stats[name];
                                if (stats.avg_raze_lifespan) txt += `<br>Avg RAZE Lifespan: ${stats.avg_raze_lifespan.toFixed(1)} yrs`;
                            }
                            layer.bindPopup(txt);
                        }
                    }
                });
                const overlays = { "Zoning Overlay": zoningLayer };
                L.control.layers(null, overlays, {collapsed: false}).addTo(map);
                zoningLayer.addTo(map); 
            }
            
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = '<h4>Type</h4>';
        
                ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
                    div.innerHTML += `<div class="map-legend-item"><span class="map-legend-color" style="background-color: ${colors[type]}; border: 1px solid ${borderColors[type]}"></span><span>${type}</span></div>`;
                });
                return div;
            };
            legend.addTo(map);
        }

        function updateMapMarkers(demolitionType = 'RAZE') {
            mapMarkers.forEach(marker => map.removeLayer(marker));
            mapMarkers = [];

            const foundationMap = {
                'C': 'Crawl Space',
                'B': 'Basement',
                'S': 'Slab',
                'P': 'Pier',
                'I': 'Pile',
                'F': 'Fill',
                'W': 'Solid Wall'
            };
            
            if (!mapData) return;
            

            let filteredData = mapData.filter(d => {
                const dtype = d.type || d.demolition_type;
                return demolitionType === 'all' ? true : dtype === demolitionType;
            });
            
            filteredData.forEach(point => {
                const dtype = point.type || point.demolition_type;
                const markerColor = colors[dtype] || colors.single;
                const borderColor = borderColors[dtype] || borderColors.single;
                
                const marker = L.circleMarker([point.lat, point.lng], {
                    radius: 4,
                    fillColor: markerColor,
                    color: borderColor,
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 1
                });

                const lifespan = point.lifespan ? point.lifespan + ' yrs' : 'N/A';
                const mat = point.material || 'Unknown';
                const fnd = point.foundation || 'Unknown';
                const yr = point.year_built || 'N/A';
                const rawFnd = point.foundation;
                const fndLabel = foundationMap[rawFnd] ? foundationMap[rawFnd] : (rawFnd || 'Unknown');
                marker.bindTooltip(`
                    <div style="text-align:left; font-size:13px;">
                        <strong>Type:</strong> ${dtype}<br>
                        <strong>Lifespan:</strong> ${lifespan}<br>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #ddd;">
                        <strong>Year Built:</strong> ${yr}<br>
                        <strong>Material:</strong> ${mat}<br>
                        <strong>Foundation:</strong> ${fndLabel}
                    </div>
                `, { direction: 'top' });
                
                marker.addTo(map);
                mapMarkers.push(marker);
            });
        }

        // NEW function to aggregate data for 'All Types'
        function aggregateAllTypesData(data) {
            const aggregated = {};
            if (!data.RAZE) return aggregated;

            const binSizes = Object.keys(data.RAZE); // e.g., ['bin_10', 'bin_20', ...]

            binSizes.forEach(binKey => {
                aggregated[binKey] = {};
                const allMaterials = new Set([...Object.keys(data.RAZE[binKey]), ...Object.keys(data.EXTDEM[binKey]), ...Object.keys(data.INTDEM[binKey])]);

                allMaterials.forEach(material => {
                    aggregated[binKey][material] = {};
                    const allLifespanBins = new Set([
                        ...Object.keys(data.RAZE[binKey][material] || {}),
                        ...Object.keys(data.EXTDEM[binKey][material] || {}),
                        ...Object.keys(data.INTDEM[binKey][material] || {})
                    ]);

                    allLifespanBins.forEach(lifespanBin => {
                        const razeCount = data.RAZE[binKey][material]?.[lifespanBin] || 0;
                        const extdemCount = data.EXTDEM[binKey][material]?.[lifespanBin] || 0;
                        const intdemCount = data.INTDEM[binKey][material]?.[lifespanBin] || 0;
                        aggregated[binKey][material][lifespanBin] = razeCount + extdemCount + intdemCount;
                    });
                });
            });
            return aggregated;
        }

        /**
         * Generates the Material vs. Lifespan Heatmap.
         * Percentage is calculated based on the GRAND TOTAL of the table.
         */
        function createHeatmap(demoType, binSize, displayMode) {
            const binKey = `bin_${binSize}`;
            const metricInput = document.querySelector('input[name="globalMetric"]:checked');
            const metricVal = metricInput ? metricInput.value : 'count';
            
            const isPct = metricVal.includes('_pct'); 
            const baseMetric = metricVal.replace('_pct', ''); 
            
            // Select Data Sources
            const displaySource = (baseMetric === 'gfa') 
                ? currentData.material_lifespan_demo_gfa 
                : currentData.material_lifespan_demo;

            const displayData = displaySource?.[demoType]?.[binKey] || {};

            const sortSource = currentData.material_lifespan_demo;
            if (!sortSource || !sortSource[demoType] || !sortSource[demoType][binKey]) {
                document.getElementById('heatmapContent').innerHTML = `<div class="error-message">No data available.</div>`;
                return;
            }
            const sortData = sortSource[demoType][binKey];

            // --- NEW STEP: Calculate Grand Total for Denominator ---
            let grandTotal = 0;
            // We iterate over displayData to sum up everything visible
            Object.values(displayData).forEach(bins => {
                grandTotal += Object.values(bins).reduce((a, b) => a + b, 0);
            });

            // Sort Rows (Materials) based on Count (Sort Logic remains the same)
            const sortTotals = {};
            Object.entries(sortData).forEach(([material, lifespans]) => {
                sortTotals[material] = Object.values(lifespans).reduce((sum, val) => sum + val, 0);
            });
            
            let sortedMaterials = Object.keys(sortTotals).sort((a, b) => sortTotals[b] - sortTotals[a]);
            sortedMaterials = sortedMaterials.slice(0, 20); 

            sortedMaterials.sort((a, b) => {
                const lowerA = a.toLowerCase();
                const lowerB = b.toLowerCase();
                if (lowerA === 'unknown') return 1;  
                if (lowerB === 'unknown') return -1; 
                return sortTotals[b] - sortTotals[a];
            });
            
            // Determine Columns
            const allLifespanBins = new Set();
            sortedMaterials.forEach(material => {
                if(sortData[material]) {
                    Object.keys(sortData[material]).forEach(bin => allLifespanBins.add(bin));
                }
            });
            
            const sortedLifespanBins = Array.from(allLifespanBins).sort((a, b) => {
                const getFirstNum = (str) => parseInt(str.match(/\d+/)?.[0] || 0);
                return getFirstNum(a) - getFirstNum(b);
            });
            
            // Calculate Max Value for Color Scale
            let maxValue = 0;
            sortedMaterials.forEach(material => {
                if (displayData[material]) {
                    Object.values(displayData[material]).forEach(val => {
                        if (isPct) {
                            // NEW: Percentage of GRAND TOTAL
                            const pct = grandTotal > 0 ? (val / grandTotal * 100) : 0;
                            maxValue = Math.max(maxValue, pct);
                        } else {
                            maxValue = Math.max(maxValue, val);
                        }
                    });
                }
            });
            
            // Generate HTML
            let html = '<div class="heatmap-container">';
            html += '<table class="heatmap-table">';
            html += '<thead><tr>';
            html += '<th class="material-header">Material</th>';
            sortedLifespanBins.forEach(bin => {
                html += `<th>${bin.replace(' years', '')}</th>`;
            });
            html += '<th>Total</th>'; 
            html += '</tr></thead>';
            html += '<tbody>';
            
            sortedMaterials.forEach(material => {
                html += '<tr>';
                html += `<td class="material-name">${material}</td>`;
                
                // This row's total (just for display in the last column)
                let rowTotal = 0;
                if (displayData[material]) {
                    rowTotal = Object.values(displayData[material]).reduce((a,b)=>a+b,0);
                }

                sortedLifespanBins.forEach(bin => {
                    const value = displayData[material]?.[bin] || 0;
                    
                    let displayValue = "";
                    let colorValue = 0; 

                    if (isPct) {
                        // NEW: Percentage of GRAND TOTAL
                        const pct = grandTotal > 0 ? (value / grandTotal * 100) : 0;
                        colorValue = pct; 
                        // Displaying with 2 decimals might be better for Global Pct as values are smaller
                        displayValue = value > 0 ? pct.toFixed(2) + '%' : '';
                    } else {
                        colorValue = value;
                        displayValue = value > 0 ? value.toLocaleString() : '';
                    }
                    
                    const bgColor = getPlasmaColor(colorValue, maxValue);
                    const intensity = maxValue > 0 ? colorValue / maxValue : 0;
                    const textColor = intensity > 0.5 ? 'white' : '#333'; 
                    
                    html += `<td style="background-color: ${bgColor}; color: ${textColor};">`;
                    html += `<div class="heatmap-cell">${displayValue}</div>`;
                    html += '</td>';
                });
                
                // The last column still shows the absolute row total (or we could show row % of total, but absolute is usually more useful here)
                html += `<td style="background-color: #f8f9fa; font-weight: bold;">${rowTotal.toLocaleString()}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            // Legend
            html += '<div class="heatmap-legend">';
            html += '<div class="legend-gradient">';
            html += `<span>0${isPct ? '%' : ''}</span><div class="gradient-bar"></div>`;
            // Max value legend
            html += `<span>${maxValue.toLocaleString(undefined, {maximumFractionDigits: 2})}${isPct ? '%' : ''}</span></div>`;
            
            let metricLabel = '';
            if (baseMetric === 'gfa') metricLabel = 'Estimated GFA';
            else metricLabel = 'Count';
            if (isPct) metricLabel += ' (% of Grand Total)';

            html += `<div>Metric: <strong>${metricLabel}</strong></div>`;
            html += '</div>';
            
            document.getElementById('heatmapContent').innerHTML = html;
        }

        function createFoundationHeatmap(demoType, binSize, displayMode) {
            const binKey = `bin_${binSize}`;
            const metricInput = document.querySelector('input[name="globalMetric"]:checked');
            const metricVal = metricInput ? metricInput.value : 'count';
            
            const isPct = metricVal.includes('_pct');
            const baseMetric = metricVal.replace('_pct', '');

            const displaySource = (baseMetric === 'gfa') 
                ? currentData.foundation_lifespan_demo_gfa 
                : currentData.foundation_lifespan_demo;

            const displayData = displaySource?.[demoType]?.[binKey] || {};
            const sortSource = currentData.foundation_lifespan_demo;

            if (!sortSource || !sortSource[demoType] || !sortSource[demoType][binKey]) {
                document.getElementById('foundationHeatmapContent').innerHTML = `<div class="error-message">No data available.</div>`;
                return;
            }
            const sortData = sortSource[demoType][binKey];

            // --- NEW STEP: Calculate Grand Total ---
            let grandTotal = 0;
            Object.values(displayData).forEach(bins => {
                grandTotal += Object.values(bins).reduce((a, b) => a + b, 0);
            });

            // Sort Rows
            const sortTotals = {};
            Object.entries(sortData).forEach(([foundation, lifespans]) => {
                sortTotals[foundation] = Object.values(lifespans).reduce((sum, val) => sum + val, 0);
            });
            
            let sortedFoundations = Object.keys(sortTotals).sort((a, b) => sortTotals[b] - sortTotals[a]);
            sortedFoundations = sortedFoundations.slice(0, 20); 

            sortedFoundations.sort((a, b) => {
                const lowerA = a.toLowerCase();
                const lowerB = b.toLowerCase();
                if (lowerA === 'unknown') return 1;  
                if (lowerB === 'unknown') return -1; 
                return sortTotals[b] - sortTotals[a];
            });
            
            // Determine Columns
            const allLifespanBins = new Set();
            sortedFoundations.forEach(foundation => {
                if(sortData[foundation]) {
                    Object.keys(sortData[foundation]).forEach(bin => allLifespanBins.add(bin));
                }
            });
            
            const sortedLifespanBins = Array.from(allLifespanBins).sort((a, b) => {
                const getFirstNum = (str) => parseInt(str.match(/\d+/)?.[0] || 0);
                return getFirstNum(a) - getFirstNum(b);
            });
            
            // Calculate Max Value
            let maxValue = 0;
            sortedFoundations.forEach(foundation => {
                if (displayData[foundation]) {
                    Object.values(displayData[foundation]).forEach(val => {
                        if (isPct) {
                            const pct = grandTotal > 0 ? (val / grandTotal * 100) : 0;
                            maxValue = Math.max(maxValue, pct);
                        } else {
                            maxValue = Math.max(maxValue, val);
                        }
                    });
                }
            });
            
            // Generate HTML
            let html = '<div class="heatmap-container">';
            html += '<table class="heatmap-table">';
            html += '<thead><tr>';
            html += '<th class="material-header">Foundation</th>'; 
            sortedLifespanBins.forEach(bin => {
                html += `<th>${bin.replace(' years', '')}</th>`;
            });
            html += '<th>Total</th>'; 
            html += '</tr></thead>';
            html += '<tbody>';
            
            sortedFoundations.forEach(foundation => {
                html += '<tr>';
                html += `<td class="material-name">${foundation}</td>`;
                
                let rowTotal = 0;
                if (displayData[foundation]) {
                    rowTotal = Object.values(displayData[foundation]).reduce((a,b)=>a+b,0);
                }

                sortedLifespanBins.forEach(bin => {
                    const value = displayData[foundation]?.[bin] || 0;
                    
                    let displayValue = "";
                    let colorValue = 0;

                    if (isPct) {
                        // NEW: Pct of Grand Total
                        const pct = grandTotal > 0 ? (value / grandTotal * 100) : 0;
                        colorValue = pct;
                        displayValue = value > 0 ? pct.toFixed(2) + '%' : '';
                    } else {
                        colorValue = value;
                        displayValue = value > 0 ? value.toLocaleString() : '';
                    }
                    
                    const bgColor = getPlasmaColor(colorValue, maxValue);
                    const intensity = maxValue > 0 ? colorValue / maxValue : 0;
                    const textColor = intensity > 0.5 ? 'white' : '#333';
                    
                    html += `<td style="background-color: ${bgColor}; color: ${textColor};">`;
                    html += `<div class="heatmap-cell">${displayValue}</div>`;
                    html += '</td>';
                });
                
                html += `<td style="background-color: #f8f9fa; font-weight: bold;">${rowTotal.toLocaleString()}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += '<div class="heatmap-legend">';
            html += '<div class="legend-gradient">';
            html += `<span>0${isPct ? '%' : ''}</span><div class="gradient-bar"></div>`;
            html += `<span>${maxValue.toLocaleString(undefined, {maximumFractionDigits: 2})}${isPct ? '%' : ''}</span></div>`;

            let metricLabel = '';
            if (baseMetric === 'gfa') metricLabel = 'Estimated GFA';
            else metricLabel = 'Count';
            if (isPct) metricLabel += ' (% of Grand Total)';

            html += `<div>Metric: <strong>${metricLabel}</strong></div>`;
            html += '</div>';
            
            document.getElementById('foundationHeatmapContent').innerHTML = html;
        }

        function setVisualizationType(type) {
            currentVisualization = type;
            document.getElementById('heatmapBtn').classList.toggle('active', type === 'heatmap');
            document.getElementById('stackedBtn').classList.toggle('active', type === 'stacked');
            updateVisualization();
        }

        function updateVisualization() {
            if (!currentData) return;
            const globalMaxAge = computeGlobalMaxAge(currentData);
            const binSize = parseInt(document.getElementById('lifespanBinSize').value);
            const displayMode = document.getElementById('viewMode').value;
            
            if (currentVisualization === 'heatmap') {
                document.getElementById('heatmapContainer').classList.remove('hidden');
                document.getElementById('foundationHeatmapContainer').classList.remove('hidden');
                document.getElementById('allChartContainer').classList.add('hidden');
                document.getElementById('razeChartContainer').classList.add('hidden');
                document.getElementById('extdemChartContainer').classList.add('hidden');
                document.getElementById('intdemChartContainer').classList.add('hidden');
                
                const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
                createHeatmap(demolitionView, binSize, displayMode);
                createFoundationHeatmap(demolitionView, binSize, displayMode);
            } else {
                document.getElementById('heatmapContainer').classList.add('hidden');
                document.getElementById('foundationHeatmapContainer').classList.add('hidden');
                updateDemolitionView(); // This will show the correct stacked chart
            }
            createLifespanChart(currentData, globalMaxAge);

            createCurrentAgeChart(currentData.current_age_distribution_10yr, binSize, globalMaxAge);


            createAgeDistributionChart(currentData.yearly_age_distribution);
            createConstructionEraChart(currentData.yearly_construction_era);
            createLifespanStripPlot(currentData.lifespan_by_year_boxplot);
        }

        // Function to calculate average lifespan for selected demolition type
        function calculateAverageLifespan(demolitionType) {
            if (!currentData || !currentData.material_lifespan_demo_avg) return null;
            
            if (demolitionType === 'all') {
                return currentData.summary_stats.average_lifespan;
            }
            
            return currentData.material_lifespan_demo_avg[demolitionType] || null;
        }

        // Function to update stats based on demolition type
        function updateStats(demolitionType) {
            if (!currentData) return;
            
            // Update average lifespan based on demolition type
            const avgLifespan = calculateAverageLifespan(demolitionType);
            const avgLifespanLabel = document.getElementById('avgLifespanLabel');
            const avgLifespanValue = document.getElementById('avgLifespan');
            
            if (demolitionType === 'all') {
                avgLifespanLabel.textContent = 'Average Lifespan (All Types)';
            } else {
                avgLifespanLabel.textContent = `Average Lifespan (${demolitionType})`;
            }
            
            if (avgLifespan !== null) {
                avgLifespanValue.textContent = avgLifespan.toFixed(1) + ' yrs';
            } else {
                avgLifespanValue.textContent = 'N/A';
            }
        }

        async function loadDataFromJSON() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const mainContent = document.getElementById('mainContent');
            
            try {
                const [demoRes, zoningRes] = await Promise.all([
                    fetch('boston_demolition_data.json'),
                    fetch('Boston_Zoning_Subdistricts.geojson')
                ]);

                if (!demoRes.ok) throw new Error('Failed to load data JSON');
                
                const data = await demoRes.json();
                
                if (zoningRes.ok) {
                    globalZoningGeoJSON = await zoningRes.json();
                } else {
                    console.warn("Zoning GeoJSON failed to load");
                }

                currentData = data;
                if (data.map_points) mapData = data.map_points;
                else if (data.map_data) mapData = data.map_data;

                if (currentData.material_lifespan_demo && !currentData.material_lifespan_demo.all) {
                     currentData.material_lifespan_demo.all = aggregateAllTypesData(data.material_lifespan_demo);
                }

                loadingContainer.style.display = 'none';
                mainContent.style.display = 'block';
                
                document.querySelector('input[name="demolitionView"][value="RAZE"]').checked = true;
                document.getElementById('heatmapBtn').addEventListener('click', () => setVisualizationType('heatmap'));
                document.getElementById('stackedBtn').addEventListener('click', () => setVisualizationType('stacked'));
                
                updateDashboard(data);
                updateRazeLifespanSummary(data);


                setTimeout(() => {
                    initializeMap();    
                    updateMapMarkers('RAZE');
                    
                    initZoningDeepDiveMap();
                    renderZoningOverviewTable(data);
                }, 100);

            } catch (error) {
                console.error(error);
                loadingContainer.style.display = 'none';
                errorContainer.innerHTML = `<div class="error-message">${error.message}</div>`;
            }
        }
        function updateDashboard(data) {
            document.getElementById('totalDemo').textContent = data.summary_stats.total_demolitions.toLocaleString();

            const defaultAvgLifespan = data.material_lifespan_demo_avg && data.material_lifespan_demo_avg.RAZE 
                ? data.material_lifespan_demo_avg.RAZE 
                : data.summary_stats.average_lifespan;
            document.getElementById('avgLifespan').textContent = defaultAvgLifespan.toFixed(1) + ' yrs';
            document.getElementById('avgLifespanLabel').textContent = 'Average Lifespan (RAZE)';
            document.getElementById('extdemCount').textContent = data.summary_stats.extdem_count.toLocaleString();
            document.getElementById('intdemCount').textContent = data.summary_stats.intdem_count.toLocaleString();
            document.getElementById('razeCount').textContent = data.summary_stats.raze_count.toLocaleString();
            
            if (data.metadata) {
                document.getElementById('totalMABuildings').textContent = data.metadata.total_ma_buildings.toLocaleString();
                document.getElementById('bostonDemolitions').textContent = data.metadata.total_boston_demolitions.toLocaleString();
                document.getElementById('dateRange').textContent = data.metadata.year_range;

                if (document.getElementById('yearBuiltRange')) {
                    document.getElementById('yearBuiltRange').textContent = data.metadata.year_built_range || '1940-present';
                }
            }

            if (data.material_stats) {
                const tbody = document.getElementById('materialTableBody');
                tbody.innerHTML = '';
                data.material_stats.slice(0, 10).forEach(mat => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = mat.material;
                    row.insertCell(1).textContent = mat.count.toLocaleString();
                    row.insertCell(2).textContent = mat.avg_lifespan.toFixed(1) + ' yrs';
                    row.insertCell(3).textContent = mat.demolition_breakdown.INTDEM;
                    row.insertCell(4).textContent = mat.demolition_breakdown.EXTDEM;
                    row.insertCell(5).textContent = mat.demolition_breakdown.RAZE;
                });
            }

            if (data.city_stats) {
                const cityGrid = document.getElementById('cityGrid');
                cityGrid.innerHTML = '';
                data.city_stats.forEach(city => {
                    const div = document.createElement('div');
                    div.className = 'city-item';
                    div.innerHTML = `<div class="city-name">${city.city}</div><div class="city-count">${city.count.toLocaleString()} demolitions</div>`;
                    cityGrid.appendChild(div);
                });
            }

            setVisualizationType('heatmap'); // Start with heatmap view
            createYearlyChart(data.yearly_stacked);
            
            // Update boxplot with initial demolition type
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            createMaterialBoxplot(data, demolitionView);
            updateStats('RAZE');
        }

        function updateDemolitionView() {
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            
            // Update the average lifespan stat
            updateStats(demolitionView);
            
            if (currentVisualization === 'stacked') {
                document.getElementById('allChartContainer').classList.toggle('hidden', demolitionView !== 'all');
                document.getElementById('razeChartContainer').classList.toggle('hidden', demolitionView !== 'RAZE');
                document.getElementById('extdemChartContainer').classList.toggle('hidden', demolitionView !== 'EXTDEM');
                document.getElementById('intdemChartContainer').classList.toggle('hidden', demolitionView !== 'INTDEM');
                updateStackedBarCharts();
            } else {
                 updateVisualization();
            }
            
            if (currentData) {
                createYearlyChart(currentData.yearly_stacked);
                createLifespanChart(currentData);
                createMaterialBoxplot(currentData, demolitionView); // Pass demolition type to boxplot
            }

            if (map && mapData) {
                updateMapMarkers(demolitionView);
            }
        }

        function updateStackedBarCharts() {
            if (!currentData || !currentData.material_lifespan_demo) return;
            const binSize = parseInt(document.getElementById('lifespanBinSize').value);
            const displayMode = document.getElementById('viewMode').value;
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            createStackedBarChart(demolitionView, binSize, displayMode);
        }

        function createStackedBarChart(demoType, binSize, displayMode) {
            const canvasId = demoType.toLowerCase() + 'Chart';
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return; // Exit if canvas not found
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            const binKey = `bin_${binSize}`;
            const demoData = currentData.material_lifespan_demo[demoType];
            
            if (!demoData || !demoData[binKey]) {
                console.error(`No data for ${demoType} with bin size ${binSize}`);
                return;
            }
            
            const materialData = demoData[binKey];
            
            const materialTotals = {};
            Object.entries(materialData).forEach(([material, lifespans]) => {
                materialTotals[material] = Object.values(lifespans).reduce((sum, val) => sum + val, 0);
            });
            
            const sortedMaterials = Object.keys(materialTotals).sort((a, b) => materialTotals[b] - materialTotals[a]);
            
            const lifespanTotals = {};
            sortedMaterials.forEach(material => {
                Object.entries(materialData[material]).forEach(([bin, count]) => {
                    lifespanTotals[bin] = (lifespanTotals[bin] || 0) + count;
                });
            });
            
            const sortedLifespanBins = Object.keys(lifespanTotals).sort((a, b) => lifespanTotals[b] - lifespanTotals[a]);
            
            const colors = getLifespanColors(sortedLifespanBins.length);
            
            const datasets = sortedLifespanBins.map((lifespanBin, index) => {
                const data = sortedMaterials.map(material => {
                    const value = materialData[material]?.[lifespanBin] || 0;
                    if (displayMode === 'percentage') {
                        const total = materialTotals[material];
                        return total > 0 ? (value / total) * 100 : 0;
                    }
                    return value;
                });
                
                return {
                    label: lifespanBin,
                    data: data,
                    backgroundColor: colors[index],
                    borderWidth: 0.5,
                    borderColor: 'rgba(255, 255, 255, 0.5)'
                };
            });
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: { labels: sortedMaterials, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Material Type' } },
                        y: { stacked: true, title: { display: true, text: displayMode === 'percentage' ? 'Percentage (%)' : 'Count' }, max: displayMode === 'percentage' ? 100 : undefined }
                    },
                    plugins: {
                        legend: { display: true, position: 'right', reverse: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ${displayMode === 'percentage' ? value.toFixed(1) + '%' : value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createYearlyChart(yearlyData) {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if (charts.yearly) charts.yearly.destroy();
            
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            const years = yearlyData.map(d => d.year);
            let datasets = [];
            
            let typesToShow = [];

            if (demolitionView === 'all') {

                typesToShow = [
                    { key: 'RAZE', label: 'RAZE (>0 yrs)', color: colors.RAZE },
                    { key: 'EXTDEM', label: 'EXTDEM', color: colors.EXTDEM },
                    { key: 'INTDEM', label: 'INTDEM', color: colors.INTDEM },
                    { key: 'demolished_and_replaced', label: 'Demolished & Replaced (≤0 yrs)', color: colors.demolished_and_replaced }
                ];
            } else if (demolitionView === 'RAZE') {
                typesToShow = [
                    { key: 'RAZE', label: 'RAZE (>0 yrs)', color: colors.RAZE },
                    { key: 'demolished_and_replaced', label: 'Demolished & Replaced (≤0 yrs)', color: colors.demolished_and_replaced }
                ];
            } else {
                typesToShow = [
                    { key: demolitionView, label: demolitionView, color: colors[demolitionView] }
                ];
            }

            typesToShow.forEach(type => {
                datasets.push({
                    label: type.label,
                    data: yearlyData.map(d => d[type.key] || 0),
                    backgroundColor: type.color,
                    borderWidth: 0,
                    borderColor: 'rgba(255,255,255,0.5)' 
                });
            });

            charts.yearly = new Chart(ctx, {
                type: 'bar',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true, 
                            title: { display: true, text: 'Year' } 
                        },
                        y: { 
                            stacked: true, 
                            title: { display: true, text: 'Count' } 
                        }
                    },
                    plugins: {
                        legend: { display: true, reverse: true }, 
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }


        function parseRange(str) {
            const m = String(str).match(/(\d+)\s*-\s*(\d+)/); 
            return m ? [parseInt(m[1]), parseInt(m[2])] : [0, 0]; 
        }


        function createLifespanChart(data, globalMaxAge) { 
            const ctx = document.getElementById('lifespanChart').getContext('2d');
            if (charts.lifespan) charts.lifespan.destroy();
            
            const binSize = parseInt(document.getElementById('lifespanBinSize').value);
            const demolitionView = document.querySelector('input[name="demolitionView"]:checked').value;
            const useLogScale = document.getElementById('logScale').checked;
            const labels = [];
            const safeMaxAge = Math.max(globalMaxAge || 150, 150); 
            for (let start = 0; start < safeMaxAge; start += binSize) {
                labels.push(`${start}-${start + binSize}`);
            }

            const rawData = data.lifespan_distribution || [];

            function getCountForRange(type, start, end) {
                let count = 0;
                rawData.forEach(d => {
                    const [dStart, dEnd] = parseRange(d.range);

                    if (dStart >= start && dEnd <= end) {
                        count += (d[type] || 0);
                    }
                });
                return count;
            }

            let datasets = [];

            if (demolitionView === 'all') {
                ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
                    const dataPoints = labels.map(lbl => {
                        const [s, e] = parseRange(lbl);
                        return getCountForRange(type, s, e);
                    });

                    datasets.push({
                        label: type,
                        data: dataPoints,
                        backgroundColor: colors[type],
                        borderWidth: 1
                    });
                });
            } else {
                const dataPoints = labels.map(lbl => {
                    const [s, e] = parseRange(lbl);
                    return getCountForRange(demolitionView, s, e);
                });

                datasets.push({
                    label: demolitionView,
                    data: dataPoints,
                    backgroundColor: colors[demolitionView],
                    borderWidth: 1
                });
            }

            charts.lifespan = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        x: { 
                            stacked: demolitionView === 'all', // 只有 All 的时候才堆叠
                            title: {display: true, text: 'Lifespan (Synced X-Axis)'},
                            ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                        },
                        y: { 
                            stacked: demolitionView === 'all',
                            title: {display: true, text: 'Count'},
                            type: useLogScale ? 'logarithmic' : 'linear',
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createCurrentAgeChart(ageData, binSize, globalMaxAge) {
            const ctx = document.getElementById('currentAgeChart').getContext('2d');
            if (charts.currentAge) charts.currentAge.destroy();
            
            const useLogScale = document.getElementById('logScale').checked;

            const labels = [];
            const safeMaxAge = Math.max(globalMaxAge || 150, 150);
            for (let start = 0; start < safeMaxAge; start += binSize) {
                labels.push(`${start}-${start + binSize}`);
            }

            const rawData = ageData || [];

            function getCountForRange(start, end) {
                let count = 0;
                rawData.forEach(d => {
                    const [dStart, dEnd] = parseRange(d.range);
                    if (dStart >= start && dEnd <= end) {
                        count += (d.count || 0);
                    }
                });
                return count;
            }

            const data = labels.map(lbl => {
                const [s, e] = parseRange(lbl);
                return getCountForRange(s, e);
            });

            charts.currentAge = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Current Buildings',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Building Age (Years)' },
                            ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                        },
                        y: { 
                            title: { display: true, text: 'Count' }, 
                            type: useLogScale ? 'logarithmic' : 'linear',
                            beginAtZero: true 
                        }
                    }
                }
            });
        }

        // 2. Age Distribution by Year
        function createAgeDistributionChart(ageDistData) {
            const ctx = document.getElementById('ageDistributionChart').getContext('2d');
            if (charts.ageDistribution) charts.ageDistribution.destroy();

            if (!ageDistData) return;

            const years = Object.keys(ageDistData).sort();
            const ageBins = [
                '0-5 years', '5-10 years', '10-20 years', '20-30 years', 
                '30-50 years', '50-75 years', '75-100 years', '100-150 years', '150+ years'
            ];
            
            const plasmaColors = [
                'rgba(13, 8, 135, 0.8)', 'rgba(84, 2, 163, 0.8)', 'rgba(139, 10, 165, 0.8)',
                'rgba(185, 50, 137, 0.8)', 'rgba(219, 92, 104, 0.8)', 'rgba(244, 136, 73, 0.8)',
                'rgba(254, 188, 43, 0.8)', 'rgba(240, 249, 33, 0.8)', 'rgba(240, 249, 33, 0.9)'
            ];

            const datasets = ageBins.map((bin, i) => ({
                label: bin,
                data: years.map(y => ageDistData[y]?.All?.[bin] || 0), // Defaulting to 'All'
                backgroundColor: plasmaColors[i],
                borderWidth: 0
            }));

            charts.ageDistribution = new Chart(ctx, {
                type: 'bar',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        }

        // 3. Construction Era Chart
        function createConstructionEraChart(eraData) {
            const ctx = document.getElementById('constructionEraChart').getContext('2d');
            if (charts.constructionEra) charts.constructionEra.destroy();

            if (!eraData) return;
            const years = Object.keys(eraData).sort();
            const eras = ['Pre-1900', '1900-1920', '1920-1940', '1940-1960', '1960-1980', '1980-2000', '2000-2010', '2010-2020', '2020+'];
            const eraColors = [
                'rgba(13, 8, 135, 0.8)', 'rgba(84, 2, 163, 0.8)', 'rgba(139, 10, 165, 0.8)',
                'rgba(185, 50, 137, 0.8)', 'rgba(219, 92, 104, 0.8)', 'rgba(244, 136, 73, 0.8)',
                'rgba(254, 188, 43, 0.8)', 'rgba(240, 249, 33, 0.8)', 'rgba(250, 250, 100, 0.9)'
            ];

            const datasets = eras.map((era, i) => ({
                label: era,
                data: years.map(y => eraData[y]?.All?.[era] || 0),
                backgroundColor: eraColors[i],
                borderWidth: 0
            }));

            charts.constructionEra = new Chart(ctx, {
                type: 'bar',
                data: { labels: years, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        }

    function createLifespanStripPlot(boxplotData) {
            const ctx = document.getElementById('lifespanStripPlot').getContext('2d');
            if (charts.lifespanStripPlot) charts.lifespanStripPlot.destroy();
            
            if (!boxplotData) return;

            const dataArr = Array.isArray(boxplotData) ? boxplotData : (boxplotData['All'] || []);

            const years = dataArr.map(d => d.year.toString());
            const stripData = [];
            const medianData = [];
            const meanData = []; 

            dataArr.forEach(d => {
                const lifespans = (d.lifespan || d.lifespans || []).sort((a,b)=>a-b);
                if (lifespans.length > 0) {
 
                     lifespans.forEach(l => stripData.push({x: d.year.toString(), y: l}));
                     
                     medianData.push(lifespans[Math.floor(lifespans.length * 0.5)]);

                     const sum = lifespans.reduce((acc, val) => acc + val, 0);
                     meanData.push(sum / lifespans.length);
                } else {
                    medianData.push(null);
                    meanData.push(null);
                }
            });

            charts.lifespanStripPlot = new Chart(ctx, {
                type: 'scatter',
                data: {
                    labels: years,
                    datasets: [
                        { 
                            label: 'Buildings', 
                            data: stripData, 
                            backgroundColor: 'rgba(126,3,168,0.3)', 
                            type: 'scatter', 
                            pointRadius: 1.5 
                        },
                        { 
                            label: 'Median', 
                            data: medianData, 
                            borderColor: 'orange', 
                            type: 'line', 
                            pointRadius: 0, 
                            tension: 0.1 
                        },

                        { 
                            label: 'Mean', 
                            data: meanData, 
                            borderColor: '#e74c3c', 
                            borderDash: [5, 5],     
                            type: 'line', 
                            pointRadius: 0, 
                            tension: 0.1 
                        }
                    ]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        x: { type: 'category', title: {display: true, text: 'Demolition Year'} },
                        y: { title: {display: true, text: 'Lifespan (Years)'} }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + ' yrs';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMaterialBoxplot(data, demolitionType = 'RAZE') {
            const ctx = document.getElementById('boxplotChart')?.getContext('2d');
            if (!ctx) return;
            
            if (charts.boxplot) charts.boxplot.destroy();
            
            // Update title and description
            const titleElement = document.getElementById('boxplotTitle');
            const descriptionElement = document.getElementById('boxplotDescription');
            
            if (demolitionType === 'all') {
                titleElement.textContent = 'Building Lifespan by Material Type (All Demolition Types)';
                descriptionElement.textContent = 'Box plot showing the distribution of building lifespans for each material type across all demolition types';
            } else {
                titleElement.textContent = `Building Lifespan by Material Type (${demolitionType} Only)`;
                descriptionElement.textContent = `Box plot showing the distribution of building lifespans for each material type for ${demolitionType} demolitions`;
            }
            
            // Check if we have the raw lifespan data with demolition types
            if (!data.material_lifespan_raw_by_demo) {
                console.error('No raw lifespan data available for boxplot by demolition type');
                return;
            }
            
            let rawData;
            if (demolitionType === 'all') {
                // Combine all demolition types
                rawData = {};
                const demoTypes = ['RAZE', 'EXTDEM', 'INTDEM'];
                
                demoTypes.forEach(demo => {
                    if (data.material_lifespan_raw_by_demo[demo]) {
                        Object.entries(data.material_lifespan_raw_by_demo[demo]).forEach(([material, values]) => {
                            if (!rawData[material]) {
                                rawData[material] = [];
                            }
                            rawData[material] = rawData[material].concat(values);
                        });
                    }
                });
            } else {
                // Use specific demolition type
                rawData = data.material_lifespan_raw_by_demo[demolitionType];
                
                if (!rawData) {
                    console.error(`No raw lifespan data available for ${demolitionType}`);
                    return;
                }
            }
            
            const materials = Object.keys(rawData);
            
            // Sort materials by median lifespan for better visualization
            materials.sort((a, b) => {
                const medianA = rawData[a].sort((x, y) => x - y)[Math.floor(rawData[a].length / 2)];
                const medianB = rawData[b].sort((x, y) => x - y)[Math.floor(rawData[b].length / 2)];
                return medianB - medianA;
            });
            
            // Limit to top 15 materials by count
            const materialCounts = materials.map(m => ({ material: m, count: rawData[m].length }));
            materialCounts.sort((a, b) => b.count - a.count);
            const top15Materials = materialCounts.slice(0, 15).map(item => item.material);
            
            // Create the boxplot chart
            charts.boxplot = new Chart(ctx, {
                type: 'boxplot',
                data: {
                    labels: top15Materials,
                    datasets: [{
                        label: `Lifespan Distribution`,
                        
                        // === Change 1: Remove Color (Monochrome Style) ===
                        backgroundColor: 'transparent',  
                        borderColor: '#333333',        
                        borderWidth: 1.5,                
                        
                        outlierColor: '#666666',      
                        outlierBackgroundColor: '#666666', 
                        outlierRadius: 2,         
                        
                        medianColor: '#000000',        
                        itemRadius: 0,                 

                        // === Change 2: Make Thinner ===
                        barPercentage: 0.4,            
                        categoryPercentage: 0.8,       
                        
                        data: top15Materials.map(material => rawData[material])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const material = top15Materials[context.dataIndex];
                                    const values = rawData[material].sort((a, b) => a - b);
                                    const q1 = values[Math.floor(values.length * 0.25)];
                                    const median = values[Math.floor(values.length * 0.5)];
                                    const q3 = values[Math.floor(values.length * 0.75)];
                                    const min = Math.min(...values);
                                    const max = Math.max(...values);
                                    const count = values.length;
                                    
                                    return [
                                        `Material: ${material}`,
                                        `Count: ${count}`,
                                        `Min: ${min.toFixed(1)} yrs`,
                                        `Q1: ${q1.toFixed(1)} yrs`,
                                        `Median: ${median.toFixed(1)} yrs`,
                                        `Q3: ${q3.toFixed(1)} yrs`,
                                        `Max: ${max.toFixed(1)} yrs`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Building Lifespan (years)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Material Type'
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // 1. RAZE Summary Badges
        function updateRazeLifespanSummary(data) {
            if (!data || !data.summary_stats || !data.summary_stats.raze_status_by_lifespan) return;
            const s = data.summary_stats;
            const sb = s.raze_status_by_lifespan;
            
            // Helper functions
            const setTxt = (id, val) => { 
                const el = document.getElementById(id); 
                if(el) el.innerText = val.toLocaleString(); 
            };
            const setBadge = (id, val, label) => { 
                const el = document.getElementById(id); 
                if(el) el.innerText = `${val.toLocaleString()} ${label}`; 
            };

            // 1. Positive
            setTxt('razePosCount', sb.positive.close + sb.positive.open);
            setBadge('razePosClose', sb.positive.close, 'Close');
            setBadge('razePosOpen', sb.positive.open, 'Open');

            // 2. Zero
            setTxt('razeZeroCount', sb.zero.close + sb.zero.open);
            setBadge('razeZeroClose', sb.zero.close, 'Close');
            setBadge('razeZeroOpen', sb.zero.open, 'Open');

            // 3. Negative
            setTxt('razeNegCount', sb.negative.close + sb.negative.open);
            setBadge('razeNegClose', sb.negative.close, 'Close');
            setBadge('razeNegOpen', sb.negative.open, 'Open');

            // 4. Total
            if (sb.total) {
                setTxt('razeTotalCount', sb.total.close + sb.total.open);
                setBadge('razeTotalClose', sb.total.close, 'Close');
                setBadge('razeTotalOpen', sb.total.open, 'Open');
            }
        }

        function renderZoningOverviewTable(data) {
            const stats = data.zoning_district_stats;
            const tbody = document.querySelector('#zoningOverviewTable tbody');
            const select = document.getElementById('zoningDistrictFilter');
            if (!tbody || !stats) return;

            tbody.innerHTML = '';
            select.innerHTML = '<option value="">Select a district...</option>';

            Object.keys(stats).sort().forEach(zone => {
                const d = stats[zone];
                // Option
                select.add(new Option(zone, zone));
                // Table Row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:8px; border-bottom:1px solid #eee;">${zone}</td>
                    <td style="padding:8px; text-align:right; border-bottom:1px solid #eee;">${d.count_raze}</td>
                    <td style="padding:8px; text-align:right; border-bottom:1px solid #eee;">${d.avg_raze_lifespan.toFixed(1)}</td>
                `;
                tr.onclick = () => { select.value = zone; updateZoningDeepDive(); };
                tbody.appendChild(tr);
            });

            const defaultZone = "Allston/Brighton Neighborhood";
            
            if (stats[defaultZone]) {
                select.value = defaultZone; 
                updateZoningDeepDive();    
            }
            // -------------------------
        }

        function initZoningDeepDiveMap() {
            if (!zoningDeepDiveMap && document.getElementById('zoningMap')) {
                zoningDeepDiveMap = L.map('zoningMap').setView([42.3601, -71.0589], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(zoningDeepDiveMap);
            }
        }


        function renderZoneHeatmap(heatmapData, sortData, containerId, isPct = false) {
            const container = document.getElementById(containerId);
            
            const dataForSorting = sortData || heatmapData;

            if (!dataForSorting || Object.keys(dataForSorting).length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">No data available for this district.</p>';
                return;
            }

            // --- NEW STEP: Calculate Grand Total for this District ---
            let grandTotal = 0;
            if (heatmapData) {
                Object.values(heatmapData).forEach(bins => {
                    grandTotal += Object.values(bins).reduce((a, b) => a + b, 0);
                });
            }

            // Sorting Order (Rows sorted by Total Count descending)
            const materialTotals = {};
            Object.keys(dataForSorting).forEach(mat => {
                materialTotals[mat] = Object.values(dataForSorting[mat]).reduce((sum, val) => sum + val, 0);
            });

            let materials = Object.keys(dataForSorting);
            materials.sort((a, b) => {
                const lowerA = a.toLowerCase();
                const lowerB = b.toLowerCase();
                if (lowerA === 'unknown') return 1;
                if (lowerB === 'unknown') return -1;
                return materialTotals[b] - materialTotals[a]; 
            });

            // Columns
            const allBins = new Set();
            materials.forEach(m => Object.keys(dataForSorting[m]).forEach(b => allBins.add(b)));
            const sortedBins = Array.from(allBins).sort((a, b) => {
                return parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]);
            });

            // Max Value
            let maxVal = 0;
            if (heatmapData) {
                materials.forEach(m => {
                    if (heatmapData[m]) {
                        Object.values(heatmapData[m]).forEach(v => {
                            if (isPct) {
                                // NEW: Pct of Grand Total
                                const p = grandTotal > 0 ? (v / grandTotal * 100) : 0;
                                maxVal = Math.max(maxVal, p);
                            } else {
                                maxVal = Math.max(maxVal, v);
                            }
                        });
                    }
                });
            }

            // HTML Table
            let html = '<table class="heatmap-table" style="font-size:0.85em;">';
            html += '<thead><tr><th class="material-header" style="min-width:120px;">Type</th>';
            sortedBins.forEach(b => html += `<th>${b}</th>`);
            html += '</tr></thead><tbody>';

            materials.forEach(mat => {
                html += `<tr><td class="material-name">${mat}</td>`;
                
                sortedBins.forEach(bin => {
                    const val = (heatmapData && heatmapData[mat]) ? (heatmapData[mat][bin] || 0) : 0;
                    
                    let displayVal = '';
                    let colorVal = 0;

                    if (isPct) {
                        // NEW: Pct of Grand Total
                        const pct = grandTotal > 0 ? (val / grandTotal * 100) : 0;
                        colorVal = pct;
                        displayVal = val > 0 ? pct.toFixed(1) + '%' : '';
                    } else {
                        colorVal = val;
                        displayVal = val > 0 ? val.toLocaleString() : '';
                    }

                    const bgColor = getPlasmaColor(colorVal, maxVal);
                    const intensity = maxVal > 0 ? colorVal / maxVal : 0;
                    const color = intensity > 0.5 ? 'white' : '#333';

                    html += `<td style="background-color:${bgColor}; color:${color}">${displayVal}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            // Legend footer
            const suffix = isPct ? '% (of Total)' : '';
            html += `<div style="margin-top:5px; font-size:0.8em; color:#666; text-align:right;">Max Value: ${maxVal.toLocaleString(undefined, {maximumFractionDigits: 2})}${suffix}</div>`;

            container.innerHTML = html;
        }


        function updateZoningDeepDive() {
            const zoneName = document.getElementById('zoningDistrictFilter').value;
            if (!zoneName || !currentData.zoning_district_stats[zoneName]) return;
            
            const d = currentData.zoning_district_stats[zoneName];

            // Update text stats
            document.getElementById('zoneAvgLifespan').innerText = d.avg_raze_lifespan.toFixed(1) + ' yrs';
            document.getElementById('zoneAvgAge').innerText = d.avg_current_age.toFixed(1) + ' yrs';

            document.getElementById('zoneRazeCount').innerText = (d.count_raze || 0).toLocaleString();
            document.getElementById('zoneTotalCount').innerText = (d.count_total || 0).toLocaleString();

            // Update Map (Polygon & Points)
            if (zoningDistrictLayer) zoningDeepDiveMap.removeLayer(zoningDistrictLayer);
            if (zoningRazePointLayer) zoningDeepDiveMap.removeLayer(zoningRazePointLayer);

            if (globalZoningGeoJSON) {
                const feature = globalZoningGeoJSON.features.filter(f => f.properties.Zoning_District === zoneName);
                if (feature.length) {
                    zoningDistrictLayer = L.geoJSON(feature, {
                        style: {
                            color: "purple",
                            weight: 2,
                            opacity: 0.7,
                            fillColor: "purple",
                            fillOpacity: 0.15
                        }
                    }).addTo(zoningDeepDiveMap);
                    zoningDeepDiveMap.fitBounds(zoningDistrictLayer.getBounds());
                }
            }

            const foundationMap = {
                'C': 'Crawl Space', 'B': 'Basement', 'S': 'Slab',
                'P': 'Pier', 'I': 'Pile', 'F': 'Fill', 'W': 'Solid Wall'
            };

            const markers = d.positive_raze_points.map(p => {
                const rawFnd = p.foundation;
                const fndLabel = foundationMap[rawFnd] ? foundationMap[rawFnd] : (rawFnd || 'Unknown');

                return L.circleMarker([p.lat, p.lng], {
                    radius: 4,
                    fillColor: colors.RAZE,
                    color: borderColors.RAZE,
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 1
                }).bindTooltip(`
                    <div style="text-align:left; font-size:13px;">
                        <strong>Type:</strong> RAZE<br>
                        <strong>Lifespan:</strong> ${p.lifespan} yrs<br>
                        <hr style="margin:5px 0; border:0; border-top:1px solid #ddd;">
                        <strong>Year Built:</strong> ${p.year_built}<br>
                        <strong>Material:</strong> ${p.material}<br>
                        <strong>Foundation:</strong> ${fndLabel}
                    </div>
                `, { direction: 'top' });
            });
            
            zoningRazePointLayer = L.layerGroup(markers).addTo(zoningDeepDiveMap);

            // Update Bar Charts
            if (charts.zoningDemolished) charts.zoningDemolished.destroy();
            const ctxDem = document.getElementById('zoningDemolishedAgeChart').getContext('2d');
            charts.zoningDemolished = new Chart(ctxDem, {
                type: 'bar',
                data: {
                    labels: d.demolished_age_distribution_10yr.map(x => x.range),
                    datasets: [{
                        label: 'Demolished Count',
                        data: d.demolished_age_distribution_10yr.map(x => x.count),
                        backgroundColor: colors.RAZE
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });

            if (charts.zoningCurrent) charts.zoningCurrent.destroy();
            const ctxCur = document.getElementById('zoningCurrentAgeChart').getContext('2d');
            charts.zoningCurrent = new Chart(ctxCur, {
                type: 'bar',
                data: {
                    labels: d.current_age_distribution_10yr.map(x => x.range),
                    datasets: [{
                        label: 'Building Count',
                        data: d.current_age_distribution_10yr.map(x => x.count),
                        backgroundColor: '#3498db'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });



            const metricInput = document.querySelector('input[name="deepDiveMetric"]:checked');
            const metricVal = metricInput ? metricInput.value : 'count';
            

            const isPct = metricVal.includes('_pct');

            const baseMetric = metricVal.replace('_pct', '');
            
            // === 1. Render Material Heatmap ===

            const matCountData = (d.heatmap_data && d.heatmap_data['count']) ? d.heatmap_data['count'] : {};

            const matDisplayData = (d.heatmap_data && d.heatmap_data[baseMetric]) ? d.heatmap_data[baseMetric] : {};
            

            renderZoneHeatmap(matDisplayData, matCountData, 'zoningHeatmapContainer', isPct);

            // === 2. Render Foundation Heatmap ===
            const fndCountData = (d.heatmap_data_foundation && d.heatmap_data_foundation['count']) ? d.heatmap_data_foundation['count'] : {};
            const fndDisplayData = (d.heatmap_data_foundation && d.heatmap_data_foundation[baseMetric]) ? d.heatmap_data_foundation[baseMetric] : {};


            renderZoneHeatmap(fndDisplayData, fndCountData, 'zoningFoundationHeatmapContainer', isPct);
        }



        window.addEventListener('DOMContentLoaded', loadDataFromJSON);
    </script>
</body>
</html>